<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Core -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‚ú® Constellation of Us ‚Äî Mi Amor Nights Edition ‚ú®</title>
  <meta name="theme-color" content="#0a0a2e" />

  <!-- PWA -->
  <link rel="manifest" href="/mi-amor-game/manifest.webmanifest">
  <link rel="apple-touch-icon" href="/mi-amor-game/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <!-- Open Graph / Twitter (link preview) -->
  <meta property="og:url" content="https://robzi7.github.io/mi-amor-game/" />
  <meta property="og:title" content="Constellation of Us ‚Äî Mi Amor Nights Edition üí´" />
  <meta property="og:description" content="A little sky full of our memories. Tap to begin." />
  <meta property="og:image" content="https://robzi7.github.io/mi-amor-game/og-cover.jpg" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />

  <!-- Favicon & Fonts -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚ú®</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&family=Dancing+Script:wght@600;700&display=swap" rel="stylesheet">

  <!-- Styles -->
  <style>
  :root{
    --indigo:#0a0a2e; --mid:#16213e; --royal:#1a237e; --violet:#3949ab;
    --ba-grad: radial-gradient(1200px 600px at 10% 0%, rgba(255,255,255,.08), transparent 40%),
               linear-gradient(135deg,var(--indigo) 0%,var(--mid) 30%,var(--royal) 70%,var(--violet) 100%);
    --syd-grad: radial-gradient(1200px 600px at 10% 0%, rgba(255,255,255,.08), transparent 40%),
                linear-gradient(135deg,#ffb46a 0%,#ffd08a 35%,#ffb74d 70%,#ff9800 100%);
    --gold:#ffd700; --pink:#ff69b4; --rose:#ff1493; --paper:#efe1c9;
  }
  *{box-sizing:border-box; margin:0}
  html,body{height:100%}
  body{
    font-family:'Cinzel',serif; color:#fff; background:var(--ba-grad); overflow:hidden;
  }
  body.sydney{ background:var(--syd-grad); }
  h1,h2,h3{font-weight:600}
  a{color:#ffd700}
  button{font-family:inherit}

  .stars-bg{position:fixed; inset:0; pointer-events:none; background-size:250px 150px;
    background:
      radial-gradient(2px 2px at 20px 30px,rgba(255,255,255,.9),transparent 60%),
      radial-gradient(2px 2px at 120px 90px,rgba(255,215,0,.8),transparent 60%),
      radial-gradient(1px 1px at 230px 40px,rgba(255,255,255,.6),transparent 60%),
      radial-gradient(3px 3px at 310px 120px,rgba(255,182,193,.7),transparent 60%);
    animation:twinkle 6s ease-in-out infinite alternate;
  }
  @keyframes twinkle{0%{opacity:.5;transform:scale(1)}50%{opacity:.9;transform:scale(1.05)}100%{opacity:.6;transform:scale(1)}}

  .app{position:relative; z-index:1; height:100%; display:grid; place-items:center}
  .screen{display:none; text-align:center; max-width:900px; width:95%; padding:16px; animation:fadeIn .9s ease}
  .screen.active{display:block}
  @keyframes fadeIn{from{opacity:0; transform:translateY(18px) scale(.98)} to{opacity:1; transform:none}}

  .title{font-family:'Dancing Script',cursive; font-size:clamp(2.6rem,7vw,4.5rem);
    background:linear-gradient(45deg,#ffd700,#ff69b4,#87ceeb,#ffd700); background-size:300% 300%;
    -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent; animation:grad 9s linear infinite}
  @keyframes grad{0%{background-position:0 50%}50%{background-position:100% 50%}100%{background-position:0 50%}}

  .card{
    background:linear-gradient(135deg,rgba(255,255,255,.12),rgba(255,215,0,.10));
    border:1.5px solid rgba(255,215,0,.35); border-radius:22px; padding:22px; backdrop-filter:blur(12px);
    box-shadow:0 18px 40px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.25);
    margin-inline:auto
  }
  .lead{font-size:clamp(1.05rem,2.8vw,1.3rem); line-height:1.8; color:#fff}

  .btn{
    display:inline-block; border:0; border-radius:999px; padding:14px 28px; margin:10px;
    color:#fff; cursor:pointer; font-weight:600; font-size:clamp(1rem,3.2vw,1.15rem);
    background:linear-gradient(135deg,#ff69b4 0%,#ff1493 45%,#dc143c 100%);
    box-shadow:0 10px 24px rgba(255,20,147,.35), inset 0 1px 0 rgba(255,255,255,.3);
    transition:transform .2s ease, box-shadow .2s ease;
  }
  .btn:hover{transform:translateY(-2px); box-shadow:0 14px 30px rgba(255,20,147,.5), inset 0 1px 0 rgba(255,255,255,.4)}

  .small{font-size:.9rem; opacity:.9}
  .row{display:flex; gap:10px; justify-content:center; flex-wrap:wrap}

  /* top toggles */
  .topbar{position:fixed; top:12px; left:12px; right:12px; display:flex; gap:8px; justify-content:space-between; z-index:9}
  .group{display:flex; gap:8px}
  .toggle{background:rgba(255,255,255,.12); color:#fff; border:1px solid rgba(255,215,0,.35); border-radius:16px; padding:8px 14px; cursor:pointer; font-size:.92rem; backdrop-filter:blur(10px)}
  .toggle:hover{background:rgba(255,215,0,.2)}
  .badge{font-size:.9rem; color:#ffd700}

  /* hearts & sparkles */
  .hearts, .sparkles {position:fixed; inset:0; pointer-events:none; z-index:2}
  .heart{position:absolute; font-size:18px; color:#ff69b4; opacity:.85; animation:float 12s linear infinite}
  @keyframes float{from{transform:translateY(100vh) translateX(0)} to{transform:translateY(-10vh) translateX(40px)}}
  .sparkles{opacity:0; transition:opacity .5s}
  .sparkles.active{opacity:1}
  .spark{position:absolute; width:4px; height:4px; background:#ffd700; border-radius:50%; animation:spark 1.6s ease-in-out infinite}
  @keyframes spark{0%,100%{transform:scale(0); opacity:0}50%{transform:scale(1.6); opacity:1}}

  /* constellation */
  .canvas{position:relative; width:min(92vw,900px); height:min(64vh,520px);
    border:2px solid rgba(255,215,0,.4); border-radius:26px; margin:10px auto; overflow:hidden;
    background:rgba(0,0,0,.28); box-shadow:0 30px 60px rgba(0,0,0,.45), inset 0 0 90px rgba(255,215,0,.08)}
  .info{color:#ffb6c1; margin-bottom:8px}

  .star{position:absolute; width:30px; height:30px; transform-origin:center; filter:drop-shadow(0 0 12px currentColor); animation:floatStar 3s ease-in-out infinite}
  .star::before{content:'‚≠ê'; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); animation:spin 6s linear infinite, pulse 2.3s ease-in-out infinite alternate}
  @keyframes floatStar{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
  @keyframes spin{to{transform:translate(-50%,-50%) rotate(360deg)}}
  @keyframes pulse{from{filter:brightness(1)}to{filter:brightness(1.4)}}
  .star.pop{animation:pop .9s ease}
  @keyframes pop{0%{transform:scale(0)}60%{transform:scale(1.4)}100%{transform:scale(1)}}

  .line{position:absolute; height:3px; background:linear-gradient(90deg,transparent,rgba(255,215,0,.9) 20%, rgba(255,105,180,.9) 60%, transparent); border-radius:2px; transform-origin:left center; animation:lineGrow .9s ease-out}
  @keyframes lineGrow{from{width:0; opacity:0} to{width:100%; opacity:1}}

  .hidden-heart{position:absolute; right:14px; bottom:14px; font-size:42px; color:#ff69b4; display:none;
    filter:drop-shadow(0 0 18px #ff69b4); animation:beat 1.6s ease-in-out infinite}
  .hidden-heart.show{display:block}
  @keyframes beat{0%{transform:scale(1)}50%{transform:scale(1.2)}100%{transform:scale(1)}}

  /* popups */
  .popup{position:fixed; inset:0; display:none; place-items:center; z-index:20; padding:18px}
  .popup.show{display:grid}
  .modal{max-width:680px; width:min(92vw,680px); background:linear-gradient(135deg,rgba(25,25,60,.95),rgba(50,25,80,.95)); border:3px solid var(--gold); border-radius:28px; padding:26px; text-align:center; box-shadow:0 28px 60px rgba(0,0,0,.65)}
  .scene{font-size:clamp(2.4rem,10vw,4.6rem); margin:6px 0}
  .mtitle{font-family:'Dancing Script',cursive; font-size:clamp(1.6rem,6vw,2.4rem); color:var(--gold); margin:4px 0 8px; text-shadow:0 0 14px rgba(255,215,0,.6)}
  .mtext{font-size:clamp(1rem,3.2vw,1.25rem); line-height:1.8; color:#ffb6c1; margin:10px 0 14px}

  .progress{position:fixed; top:58px; right:12px; z-index:5; background:linear-gradient(135deg,rgba(255,255,255,.12),rgba(255,215,0,.18)); border:1.5px solid rgba(255,215,0,.35); border-radius:16px; padding:10px 14px; backdrop-filter:blur(10px); color:var(--gold); font-size:.95rem}

  .fireworks{position:fixed; inset:0; pointer-events:none; z-index:25}
  .fw{position:absolute; width:6px; height:6px; border-radius:50%; animation:boom 2.8s ease-out forwards}
  @keyframes boom{from{transform:scale(1); opacity:1} to{transform:scale(28); opacity:0}}

  .heart-const{width:360px; height:280px; margin:16px auto; position:relative}
  .hstar{position:absolute; font-size:22px; filter:drop-shadow(0 0 12px #ffd700); animation:hblink 1.6s ease-in-out infinite alternate}
  @keyframes hblink{from{opacity:.6; transform:scale(.9)} to{opacity:1; transform:scale(1.15)}}

  /* BA time ribbon & share row */
  .ribbon{position:fixed; bottom:10px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,.35); border:1px solid rgba(255,215,0,.4); padding:6px 12px; border-radius:14px; font-size:.92rem; backdrop-filter:blur(6px); z-index:6}
  .ribbon.flash{animation:flash 1.4s ease}
  @keyframes flash{from{box-shadow:0 0 0 0 rgba(255,215,0,.8)} to{box-shadow:0 0 24px 10px rgba(255,215,0,0)}}

  .share{display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:10px}

  /* INTERLUDE overlay (champagne & Lindt between memory 3‚Üí4) */
  #interlude{
    position:fixed; inset:0; z-index:30; display:grid; place-items:center;
    background: rgba(0,0,0,.65);
    /* Show WebP if present, else JPG (fallback listed second layer) */
    background-image:
      image-set(
        url("./images/lindt-sepia.webp") type("image/webp"),
        url("./images/lindt-sepia.jpg") type("image/jpeg")
      ),
      url("./images/lindt-sepia.jpg");
    background-position:center; background-size:cover; background-repeat:no-repeat;
    opacity:0; pointer-events:none; transition:opacity .6s ease;
  }
  #interlude.show{ opacity:1; }
  #interlude .i-card{
    background:rgba(0,0,0,.45); color:#fff; border:1.5px solid rgba(255,215,0,.5);
    padding:14px 18px; border-radius:16px; text-align:center; backdrop-filter:blur(6px);
    font-family:'Dancing Script',cursive; font-size:1.4rem; text-shadow:0 2px 6px rgba(0,0,0,.6)
  }
  #interlude .i-sub{ font-family:'Cinzel',serif; font-size:.95rem; opacity:.9 }

  /* accessibility */
  :focus-visible{outline:2px solid #ffd700; outline-offset:3px}

  /* reduced motion */
  @media (prefers-reduced-motion: reduce){
    .heart,.spark,.star,.line,.hstar,.fw{animation:none !important}
    .hearts,.sparkles{display:none}
  }
  </style>
</head>
<body>

<div class="stars-bg"></div>

<div class="topbar">
  <div class="group">
    <button class="toggle" id="themeBtn">üåô Buenos Aires Night</button>
    <button class="toggle" id="langBtn">üá¨üáß EN</button>
    <button class="toggle" id="spicyBtn">üî• Spicy: ON</button>
  </div>
  <div class="badge" id="statusBadge">üí´</div>
</div>

<div class="progress" id="progress">‚ú® Stars: <span id="progNum">0</span>/7</div>
<div class="hearts" id="hearts"></div>
<div class="sparkles" id="sparkles"></div>

<div class="app" id="app">
  <!-- Greeting -->
  <section class="screen active" id="greet">
    <h1 class="title">‚ú® Constellation of Us ‚ú®</h1>
    <div class="card">
      <p class="lead" id="greetText">
        Good morning my Mi Amor, I‚Äôve been thinking and dreaming of you so much lately,
        I thought I‚Äôd surprise you with a game with some of these memories I‚Äôve been thinking of lately üòòüòàüî•
      </p>
    </div>
    <div class="row">
      <button class="btn" id="toMain">Continue to Your Surprise üí´</button>
    </div>
  </section>

  <!-- Main / Music -->
  <section class="screen" id="main">
    <h1 class="title">‚ú® Constellation of Us ‚ú®</h1>
    <div class="card">
      <p class="lead" id="mainIntro">
        Turn on music first, <em>por favor</em> üéµ ‚Äî then tap
        <strong>Begin Our Constellation üí´</strong>.
      </p>
      <div class="row">
        <button class="btn" id="musicBtn">üéµ Play Music</button>
        <a class="btn" id="shakiraBtn" target="_blank" rel="noopener">‚ñ∂Ô∏è Open ‚ÄúUnderneath Your Clothes‚Äù</a>
      </div>
      <p class="small" id="musicNote">Music starts after you tap ‚Äî you can pause anytime.</p>
    </div>
    <div class="row">
      <button class="btn" id="startBtn">Begin Our Constellation üí´</button>
    </div>
  </section>

  <!-- Game -->
  <section class="screen" id="game">
    <h2 class="title" style="font-size:2rem">Place the Stars of Our Love Story</h2>
    <p class="info" id="tapHint">Touch anywhere in the sky to place your next star ‚≠ê</p>
    <div class="canvas" id="canvas" role="application" aria-label="Constellation canvas">
      <div class="hidden-heart" id="secretHeart" title="Psst‚Ä¶ tap me after the 7th star üíñ">üíñ</div>
    </div>
  </section>

  <!-- Finale -->
  <section class="screen" id="finale">
    <h1 class="title">üåü Our Constellation is Complete! üåü</h1>
    <div class="heart-const" id="heartConst"></div>
    <div class="card">
      <h3 style="color:#ffd700; font-family:'Dancing Script',cursive; font-size:1.8rem">Certificate of Our Universe</h3>
      <p class="lead" id="certText">
        This constellation belongs to Mi Amor and her love, shining forever between Sydney and Buenos Aires.
        <br><em>Seven stars, seven memories, infinite love.</em>
        <br><strong>Congrats for finishing your surprise game Mi Amor‚Ä¶ now you can jump on me now, por favor ü•∫üòã</strong>
      </p>
      <div class="share">
        <button class="btn" id="againBtn">Create Another Constellation üåü</button>
        <a class="btn" id="waBtn" target="_blank" rel="noopener">Share on WhatsApp</a>
        <button class="btn" id="saveBtn">Save Constellation üì∑</button>
      </div>
    </div>
  </section>
</div>

<!-- Popups -->
<div class="popup" id="memPop">
  <div class="modal">
    <div class="scene" id="mScene">‚ú®</div>
    <div class="mtitle" id="mTitle">Title</div>
    <div class="mtext" id="mText">Text</div>
    <button class="btn" id="memOk">Continue Creating Magic ‚ú®</button>
  </div>
</div>

<div class="popup" id="secretPop">
  <div class="modal">
    <div class="scene">üíñ‚ú®</div>
    <div class="mtitle" id="sTitle">Secret Surprise Unlocked!</div>
    <div class="mtext" id="sText"></div>
    <div class="row">
      <button class="btn" id="toPlaylist">Continue to Final Surprise üéß</button>
    </div>
  </div>
</div>

<div class="popup" id="playlistPop">
  <div class="modal">
    <div class="scene">üéßüíï</div>
    <div class="mtitle">EuphoricEmotionSessions 2022 ‚Äî Mi Amor Nights ‚ú®</div>
    <div class="mtext" id="pText">
      Now press play on our playlist, and let‚Äôs start where the music left off‚Ä¶
      <br><br>
      <span style="color:#ffd700">Remembering our beautiful anniversary when we held each other for the first time at Ministro Pistarini International Airport on 28 August 2019, 10:44 AM.</span>
    </div>
    <div class="row">
      <a class="btn" id="playlistLink" target="_blank" rel="noopener">üéµ Open Our Playlist</a>
      <button class="btn" id="closePlaylist">Close & Finish Game üíï</button>
    </div>
  </div>
</div>

<!-- Fireworks + BA ribbon -->
<div class="fireworks" id="fireworks"></div>
<div class="ribbon" id="baRibbon">Buenos Aires: ‚Äî:‚Äî</div>

<!-- Interlude overlay -->
<div id="interlude" aria-hidden="true">
  <div class="i-card">
    <div>Mi Amor ‚Äî Champagne &amp; Lindt Kisses Tradition</div>
    <div class="i-sub">Buenos Aires ‚Ä¢ 28 Aug 2019</div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
<script>
/* ========= CONFIG ========= */
const spotifyTrack = "https://open.spotify.com/search/Underneath%20Your%20Clothes%20Shakira"; // opens track search
const playlistUrl  = "https://open.spotify.com/playlist/2R3GciDXqqgygQxAveD4j0?si=xaAU7KY9TYCb9TDsK6FYVA";
/* ========================= */

const qs = sel => document.querySelector(sel);
const qsa = sel => [...document.querySelectorAll(sel)];
const screens = { greet:qs('#greet'), main:qs('#main'), game:qs('#game'), finale:qs('#finale') };
const canvas = qs('#canvas'), hearts = qs('#hearts'), sparkles = qs('#sparkles');
const progress = qs('#progNum'), fireworks = qs('#fireworks');
const secretHeart = qs('#secretHeart');
const memPop = qs('#memPop'), mScene=qs('#mScene'), mTitle=qs('#mTitle'), mText=qs('#mText'), memOk=qs('#memOk');
const secretPop = qs('#secretPop'), sText=qs('#sText'), toPlaylist=qs('#toPlaylist');
const playlistPop = qs('#playlistPop'), playlistLink=qs('#playlistLink'), closePlaylist=qs('#closePlaylist');
const musicBtn = qs('#musicBtn'), shakiraBtn=qs('#shakiraBtn'), startBtn=qs('#startBtn'), toMain=qs('#toMain');
const againBtn=qs('#againBtn'), waBtn=qs('#waBtn'), saveBtn=qs('#saveBtn');
const themeBtn=qs('#themeBtn'), langBtn=qs('#langBtn'), spicyBtn=qs('#spicyBtn'), statusBadge=qs('#statusBadge');
const baRibbon = qs('#baRibbon');

let placed=[], current=0, spicy=true, lang='en', lastShown=-1;
let theme = localStorage.getItem('coou_theme')||'ba';
if(theme==='syd') document.body.classList.add('sydney');
themeBtn.textContent = theme==='ba' ? 'üåô Buenos Aires Night' : 'üå§Ô∏è Sydney Morning';

let musicCtx=null, musicNode=null, musicPlaying=false;

/* ============ CONTENT (EN + ES) ============ */
const content = {
  en:{
    greet:"Good morning my Mi Amor, I‚Äôve been thinking and dreaming of you so much lately, I thought I‚Äôd surprise you with a game with some of these memories I‚Äôve been thinking of lately üòòüòàüî•",
    mainIntro:"Turn on music first, <em>por favor</em> üéµ ‚Äî then tap <strong>Begin Our Constellation üí´</strong>.",
    musicNote:"Music starts after you tap ‚Äî you can pause anytime.",
    tapHint:"Touch anywhere in the sky to place your next star ‚≠ê",
    cert:`This constellation belongs to Mi Amor and her love, shining forever between Sydney and Buenos Aires.
          <br><em>Seven stars, seven memories, infinite love.</em>
          <br><strong>Congrats for finishing your surprise game Mi Amor‚Ä¶ now you can jump on me now, por favor ü•∫üòã</strong>`,
    secret: (spicy)=> spicy ?
      `Mi amor‚Ä¶ if you want to keep going, tap the glowing heart and imagine you‚Äôre <strong>underneath my clothes</strong>,
       slowly coming to sit on me‚Ä¶ my kisses‚Ä¶ more and more‚Ä¶ until you realize there‚Äôs <strong>one more</strong> surprise in this game. üòòüòâ
       <br><br><em>(If tonight you prefer tenderness, we can stop here and just cuddle to the music. I choose you either way.)</em>`
      :
      `Mi amor‚Ä¶ if you want to keep going, tap the glowing heart and imagine curling up on me, my kisses getting warmer and softer‚Ä¶
       until you find there‚Äôs <strong>one more</strong> surprise in this game. üíï`,
    mems:[
      {scene:"üê®üí§", title:"Koala Cuddles", text:"Every night we fall asleep like two koalas, wrapped in each other's arms... Mi Amor, your touch is my favorite place in the world. Even across the miles, I can still feel you next to me. üíï"},
      {scene:"üìöüòè", title:"Arabic Class Distractions", text:"There you are, trying so hard to focus on your Arabic lessons... and there I am, right next to you, being the most adorable distraction ever üòâ Mi Amor, I love how you try to be serious but end up laughing with me."},
      {scene:"üçùüçπ", title:"Ravioli & Mojito Nights", text:"Our perfect dinner dates: delicious ravioli and refreshing passionfruit mojitos. Every bite, every sip, every laugh across the table‚Äîthese are the moments that make distance disappear, Mi Amor. ü•∞"},
      {scene:"üõÅüïØÔ∏è", title:"Candlelit Bath Dreams", text:"Those magical bath moments with only candlelight dancing around us... Dark, romantic, and perfectly relaxing. In the soft glow, the world fades and it's just us, Mi Amor. ‚ú®"},
      {scene:"üíÉüéµ", title:"Dancing to Shakira", text:"When Shakira plays, you light up and start dancing! Your hips don't lie, Mi Amor, and neither does my heart when I watch you move. Every song becomes our song when you're dancing. üé∂"},
      {scene:"‚öΩüá¶üá∑", title:"Watching Messi Together", text:"Our dream: cheering for Messi and Argentina together in the stadium! Matching jerseys, screaming goals, celebrating like crazy. One day, Mi Amor, we'll make this dream real. üèÜ"},
      {scene:"üèàüèüÔ∏è", title:"NFL with Mahomes", text:"And then there's Mahomes and the NFL! Picture us at the game, sharing nachos, cheering touchdowns, feeling the magic together. From soccer to football‚Äîwe'll conquer every sport, Mi Amor! üéâ"}
    ],
    playlistLead:`Now press play on our playlist, and let‚Äôs start where the music left off‚Ä¶`,
  },
  es:{
    greet:"Buen d√≠a, Mi Amor. Estuve pensando y so√±ando con vos‚Ä¶ as√≠ que te hice un cielo con lo nuestro. ¬øJugamos? üòòüòàüî•",
    mainIntro:"Primero prend√© la m√∫sica, <em>por favor</em> üéµ ‚Äî y despu√©s toc√° <strong>Empezar nuestra constelaci√≥n üí´</strong>.",
    musicNote:"La m√∫sica arranca despu√©s de tocar ‚Äî pod√©s pausarla cuando quieras.",
    tapHint:"Toc√° el cielo para colocar la pr√≥xima estrella ‚≠ê",
    cert:`Esta constelaci√≥n es de Mi Amor y su amor, brillando para siempre entre S√≠dney y Buenos Aires.
          <br><em>Siete estrellas, siete recuerdos, amor infinito.</em>
          <br><strong>¬°Lo lograste, Mi Amor! Ahora‚Ä¶ salt√° encima m√≠o, por favor ü•∫üòã</strong>`,
    secret:(spicy)=> spicy ?
      `Mi amor‚Ä¶ si quer√©s seguir, toc√° el coraz√≥n brillante e imaginate <strong>debajo de mi ropa</strong>,
       viniendo despacito a sentarte en m√≠‚Ä¶ mis besos‚Ä¶ cada vez m√°s‚Ä¶ hasta que descubras que hay <strong>una sorpresita m√°s</strong>. üòòüòâ
       <br><br><em>(Si hoy prefer√≠s ternura, tambi√©n vale: nos quedamos abrazados con la m√∫sica. Te elijo igual.)</em>`
      :
      `Mi amor‚Ä¶ si quer√©s seguir, toc√° el coraz√≥n brillante e imaginate acurrucada en m√≠, mis besos m√°s c√°lidos y suaves‚Ä¶
       hasta encontrar que hay <strong>una sorpresita m√°s</strong> en este juego. üíï`,
    mems:[
      {scene:"üê®üí§", title:"Mimos de Koala", text:"Todas las noches nos dormimos como dos koalas, abrazados‚Ä¶ Mi Amor, tu caricia es mi lugar favorito. Aun con la distancia, te siento al lado. üíï"},
      {scene:"üìöüòè", title:"Distracciones en √Årabe", text:"Ah√≠ est√°s, tratando de concentrarte‚Ä¶ y ac√° estoy yo, siendo la distracci√≥n m√°s adorable üòâ Me encanta cuando intent√°s ponerte seria y termin√°s ri√©ndote conmigo, Mi Amor."},
      {scene:"üçùüçπ", title:"Ravioles & Mojitos", text:"Cenas perfectas: ravioles riqu√≠simos y mojitos de maracuy√°. Cada bocado, cada sorbo, cada risa‚Äîson momentos que borran la distancia, Mi Amor. ü•∞"},
      {scene:"üõÅüïØÔ∏è", title:"Sue√±os a la Luz de las Velas", text:"Esos ba√±os m√°gicos a la luz de las velas‚Ä¶ oscuro, rom√°ntico, relajante. En ese brillo suave, el mundo desaparece y quedamos nosotros, Mi Amor. ‚ú®"},
      {scene:"üíÉüéµ", title:"Bailando Shakira", text:"Cuando suena Shakira, te encend√©s y empez√°s a bailar. Tus caderas no mienten, Mi Amor, y mi coraz√≥n tampoco cuando te miro moverte. Cada canci√≥n se vuelve nuestra. üé∂"},
      {scene:"‚öΩüá¶üá∑", title:"Messi Juntos", text:"Nuestro sue√±o: alentar a Messi y a Argentina en la cancha. Camisetas iguales, gritos de gol, fiesta total. Un d√≠a lo vamos a cumplir, Mi Amor. üèÜ"},
      {scene:"üèàüèüÔ∏è", title:"NFL con Mahomes", text:"Y tambi√©n la NFL y Mahomes. Imaginanos en el estadio, compartiendo nachos, gritando touchdowns, viviendo la magia. Del f√∫tbol al f√∫tbol americano‚Äî¬°todo con vos, Mi Amor! üéâ"}
    ],
    playlistLead:`Ahora pon√© play en nuestra playlist y sigamos donde la m√∫sica qued√≥‚Ä¶`,
  }
};

/* ====== TEXT BINDINGS (i18n) ====== */
function applyLang(){
  qs('#greetText').innerHTML = content[lang].greet;
  qs('#mainIntro').innerHTML = content[lang].mainIntro;
  qs('#musicNote').textContent = content[lang].musicNote;
  qs('#tapHint').textContent = content[lang].tapHint;
  qs('#certText').innerHTML = content[lang].cert;
  qs('#pText').firstChild && (qs('#pText').firstChild.textContent = content[lang].playlistLead + " ");
  langBtn.textContent = (lang==='en'?'üá¨üáß EN':'üá¶üá∑ ES');
}

/* ====== MUSIC (WebAudio soft pad) ====== */
function initMusic(){
  if(musicCtx) return;
  musicCtx = new (window.AudioContext||window.webkitAudioContext)();
  const osc = musicCtx.createOscillator();
  const gain = musicCtx.createGain();
  const filt = musicCtx.createBiquadFilter();
  osc.type='sawtooth';
  osc.frequency.value=220; // A3
  filt.type='lowpass'; filt.frequency.value=1200;
  gain.gain.value=0.0001;
  osc.connect(filt).connect(gain).connect(musicCtx.destination);
  osc.start();
  gain.gain.linearRampToValueAtTime(0.02, musicCtx.currentTime+1.2);
  musicNode={osc,gain,filt};
}
function playMusic(){
  initMusic();
  if(musicCtx.state==='suspended') musicCtx.resume();
  musicNode.gain.gain.cancelScheduledValues(musicCtx.currentTime);
  musicNode.gain.gain.linearRampToValueAtTime(0.02, musicCtx.currentTime+0.8);
  musicPlaying=true; musicBtn.textContent='‚è∏ Pause Music'; statusBadge.textContent='üéµ';
}
function pauseMusic(){
  if(!musicCtx) return;
  musicNode.gain.gain.linearRampToValueAtTime(0.0001, musicCtx.currentTime+0.4);
  musicPlaying=false; musicBtn.textContent='üéµ Play Music'; statusBadge.textContent='üí´';
}

/* ====== SPARKLES & HEARTS ====== */
function burstSparkles(){
  sparkles.classList.add('active');
  for(let i=0;i<35;i++){
    const s=document.createElement('div'); s.className='spark';
    s.style.left=(Math.random()*100)+'%'; s.style.top=(Math.random()*100)+'%';
    s.style.animationDelay=(Math.random()*1.2)+'s';
    sparkles.appendChild(s); setTimeout(()=>s.remove(),1800);
  }
  setTimeout(()=>sparkles.classList.remove('active'),1200);
}
function floatHeartsLoop(){
  const h=document.createElement('div'); h.className='heart'; h.textContent='‚ù§';
  const size=16+Math.random()*14; h.style.fontSize=size+'px';
  h.style.left=(Math.random()*100)+'%'; h.style.animationDuration=(10+Math.random()*6)+'s';
  hearts.appendChild(h); setTimeout(()=>h.remove(),13000);
  requestAnimationFrame(()=>floatHeartsLoop());
}
floatHeartsLoop();

/* ====== CONSTELLATION ====== */
function lineBetween(a,b){
  const dx=b.x-a.x, dy=b.y-a.y, dist=Math.hypot(dx,dy);
  const ang=Math.atan2(dy,dx)*180/Math.PI;
  const ln=document.createElement('div');
  ln.className='line';
  ln.style.left=a.x+'px'; ln.style.top=a.y+'px';
  ln.style.width=dist+'px'; ln.style.transform=`rotate(${ang}deg)`;
  canvas.appendChild(ln);
}
function placeStar(x,y){
  const el=document.createElement('div'); el.className='star pop'; el.style.left=(x-15)+'px'; el.style.top=(y-15)+'px'; el.style.color=['#ffd700','#ff69b4','#87ceeb'][current%3];
  canvas.appendChild(el);
  if(placed.length){ lineBetween(placed[placed.length-1], {x,y}); }
  placed.push({x,y}); current++; progress.textContent=current;
  localStorage.setItem('coou_progress', current);
  showMemory(current-1);
  if(current===7){ secretHeart.classList.add('show'); statusBadge.textContent='üíñ'; }
}
canvas.addEventListener('click',(e)=>{
  if(current>=7) return;
  const rect=canvas.getBoundingClientRect();
  placeStar(e.clientX-rect.left, e.clientY-rect.top);
});

/* ====== MEMORIES ====== */
function showMemory(idx){
  lastShown = idx;
  const mem = content[lang].mems[idx];
  mScene.textContent=mem.scene; mTitle.textContent=mem.title; mText.textContent=mem.text;
  memPop.classList.add('show'); burstSparkles();
}
memOk.addEventListener('click',()=>{
  memPop.classList.remove('show');
  // Interlude right after memory #3 (index 2)
  if (lastShown === 2 && !window._interludePlayed){
    window._interludePlayed = true;
    showInterlude();
  }
});

/* ====== SECRET STAR ====== */
secretHeart.addEventListener('click',()=>{
  sText.innerHTML = content[lang].secret(spicy);
  secretPop.classList.add('show'); burstSparkles();
});
toPlaylist.addEventListener('click',()=>{
  secretPop.classList.remove('show');
  playlistLink.href = playlistUrl;
  playlistPop.classList.add('show');
});
closePlaylist.addEventListener('click',()=>{
  playlistPop.classList.remove('show');
  finishGame();
});

/* ====== INTERLUDE ====== */
const interludeEl = document.getElementById('interlude');
function showInterlude(){
  interludeEl.classList.add('show');
  setTimeout(()=> interludeEl.classList.remove('show'), 2000);
}

/* ====== FINALE ====== */
function finishGame(){
  show('finale'); drawHeartConstellation(); fireworksShow();
  const url = encodeURIComponent(location.href);
  waBtn.href = `https://wa.me/?text=Look%20at%20our%20constellation%20üí´%20${url}`;
}
againBtn.addEventListener('click',()=>{ resetGame(); });

function drawHeartConstellation(){
  const box=qs('#heartConst'); box.innerHTML='';
  for(let t=0;t<Math.PI*2;t+=0.3){
    const x = 16*Math.pow(Math.sin(t),3);
    const y = 13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t);
    const s=document.createElement('div'); s.className='hstar'; s.textContent='‚≠ê';
    s.style.left = (x*6+180)+'px'; s.style.top = ( -y*6+140)+'px';
    box.appendChild(s);
  }
}
function fireworksShow(){
  for(let i=0;i<30;i++){
    const f=document.createElement('div'); f.className='fw';
    f.style.left=(Math.random()*100)+'%'; f.style.top=(Math.random()*100)+'%';
    f.style.background=`hsl(${Math.random()*360},90%,60%)`;
    fireworks.appendChild(f); setTimeout(()=>f.remove(),2900);
  }
}

/* ====== NAV / STATE ====== */
function show(id){ Object.values(screens).forEach(s=>s.classList.remove('active')); screens[id].classList.add('active'); burstSparkles(); }
toMain.addEventListener('click',()=>{ show('main'); });
startBtn.addEventListener('click',()=>{
  show('game'); if(!musicPlaying) playMusic();
});
musicBtn.addEventListener('click',()=>{ musicPlaying?pauseMusic():playMusic(); });
shakiraBtn.href = spotifyTrack;

/* ====== THEME, LANG, SPICY ====== */
themeBtn.addEventListener('click',()=>{
  document.body.classList.toggle('sydney');
  theme = document.body.classList.contains('sydney') ? 'syd':'ba';
  themeBtn.textContent = theme==='ba' ? 'üåô Buenos Aires Night' : 'üå§Ô∏è Sydney Morning';
  localStorage.setItem('coou_theme', theme);
});
langBtn.addEventListener('click',()=>{ lang = (lang==='en'?'es':'en'); applyLang(); });
spicyBtn.addEventListener('click',()=>{
  spicy=!spicy; spicyBtn.textContent = spicy ? 'üî• Spicy: ON' : 'üå∏ Spicy: OFF';
});

/* ====== BA TIME RIBBON ====== */
function updateBA(){
  const now = new Date();
  const fmt = new Intl.DateTimeFormat('en-AR',{timeZone:'America/Argentina/Buenos_Aires',hour:'2-digit',minute:'2-digit'});
  const hhmm = fmt.format(now);
  baRibbon.textContent = `Buenos Aires: ${hhmm}`;
  if(hhmm==='10:44'){ baRibbon.classList.add('flash'); setTimeout(()=>baRibbon.classList.remove('flash'),1500); burstSparkles(); }
}
setInterval(updateBA,20000); updateBA();

/* ====== SAVE IMAGE ====== */
saveBtn?.addEventListener('click',()=>{
  html2canvas(canvas).then(c=>{
    const a=document.createElement('a'); a.download='ConstellationOfUs.png'; a.href=c.toDataURL('image/png'); a.click();
  });
});

/* ====== PROGRESS ====== */
function resetGame(){
  placed=[]; current=0; progress.textContent=0;
  canvas.innerHTML='<div class="hidden-heart" id="secretHeart" title="Psst‚Ä¶ tap me after the 7th star üíñ">üíñ</div>';
  qs('#secretHeart').addEventListener('click',()=>{ sText.innerHTML = content[lang].secret(spicy); secretPop.classList.add('show'); });
  show('game'); statusBadge.textContent='üí´';
  localStorage.removeItem('coou_progress');
}
applyLang();

/* start some hearts immediately */
for(let i=0;i<10;i++) setTimeout(()=>floatHeartsLoop(), i*250);
</script>
</body>
</html>
